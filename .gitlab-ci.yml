before_script:
  - export LANG=C
  - module load impi/5.1.3 intel/16.0 gcc/4.9 mkl/11.3 autotools pkg-config
  - module list
  - env

# define two stages, that way coverage only runs after all other
# tests have been done.
stages:
  - test
  - coverage

# autogenerated tests

autogenerated-cpu-large-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export PATH=/home/elpa/python-3.6/bin:$PATH
    - ./gitlab_ci_test cpu 1500 50 16

autogenerated-cpu-small-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export PATH=/home/elpa/python-3.6/bin:$PATH
    - ./gitlab_ci_test cpu 150 50 16

autogenerated-emulated-small-jobs:
  tags:
    - emulated
  script:
    - ./autogen.sh
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export PATH=/home/elpa/python-3.6/bin:$PATH
    - ./gitlab_ci_test emulated 150 50 16

autogenerated-gpu-large-jobs:
  tags:
    - gpu
  script:
    - ./autogen.sh
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export PATH=/home/elpa/python-3.6/bin:$PATH
    - ./gitlab_ci_test gpu 1500 500 128


# print coverage results
total_coverage:
  stage: coverage
  tags:
    - cpu
    - emulated
    - gpu
  script:
    - ./ci_coverage_summary
  artifacts:
    paths:
      - coverage_data


stages:
  - test
  - coverage
  - deploy

before_script:
  - module purge
  - export LANG=C
  - ulimit -s unlimited
  - ulimit -v unlimited
  - module load git
  - echo "HOST " $HOST
  - if [ "$HOST" != "hydra03" -a "$HOST" != "hydra04" -a "$HOST" != "hydra05"  -a "$HOST" != "hydra06"  -a "$HOST" != "hydra07"  -a "$HOST" != "knl1" -a "$HOST" != "knl2" -a "$HOST" != "knl3" -a "$HOST" != "knl4" -a "$HOST" != "gp02" -a "$HOST" != "draco01" -a "$HOST" != "draco02" -a "$HOST" != "draco03" -a "$HOST" != "draco04"  ] ; then module load impi/5.1.3 intel/16.0 gcc/5.4 mkl/11.3 autotools pkg-config; fi
  - if [ "$HOST" = "knl1" -o "$HOST" = "knl2" -o "$HOST" = "knl3" -o "$HOST" = "knl4" ] ; then module load impi/5.1.3 intel/17.0 gcc/6.3 mkl/2017 pkg-config; fi
  - if [ "$HOST" = "gp02" ] ; then module load impi/5.1.3 intel/17.0 gcc/6.3 mkl/2017 pkg-config; fi
  - if [ "$HOST" = "draco01" -o "$HOST" = "draco02" -o "$HOST" = "draco03" -o "$HOST" = "draco04" ] ; then module load impi/2017.3 intel/17.0 gcc/6.3 mkl/2017 pkg-config; fi
  - module list
  - if [ "$HOST" != "buildtest-rzg" ]; then  pushd $HOME/bin/reserve_timeslot && git pull && popd ; fi
  - source .ci-env-vars


# For some reason sometimes not-writable files remain, which cause trouble the
# next time a runner tries to clean-up
after_script:
  - chmod u+w -R .


########################################################################################
#
# jobs for intel/gfortran double/single precision mpi and no openmp no cuda SSE/AVX
# - all runners on "cpu"
# - including coverage runs
#
########################################################################################
# intel double precision mpi noomp AVX/SSE
intel-double-precision-mpi-noomp-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -mavx" FCFLAGS="-O3 -axAVX" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$SCALAPACK_FCFLAGS_MPI_NO_OMP" --disable-avx2 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# intel double precision mpi noomp AVX/SSE large
intel-double-precision-mpi-noomp-large-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -mavx" FCFLAGS="-O3 -axAVX" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_NO_OMP" --disable-avx2 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='1500 500 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# intel single precision mpi noomp AVX/SSE
intel-single-precision-mpi-noomp-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -mavx" FCFLAGS="-O3 -mavx" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_NO_OMP" --enable-single-precision --disable-avx2 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran double precision mpi noomp AVX/SSE
gfortran-double-precision-mpi-noomp-avx-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -mavx" FCFLAGS="-O3 -mavx" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --disable-avx2 FC=mpif90 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran single precision mpi noomp AVX/SSE
gfortran-single-precision-mpi-noomp-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -mavx" FCFLAGS="-O3 -mavx" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --disable-avx2 FC=mpif90 --enable-single-precision || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran single precision mpi noomp AVX/SSE no legacy
gfortran-single-precision-mpi-noomp-no-legacy-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -mavx" FCFLAGS="-O3 -mavx" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --disable-avx2 FC=mpif90 --enable-single-precision --disable-legacy || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran single precision mpi noomp AVX/SSE qr
gfortran-single-precision-mpi-noomp-qr-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -mavx" FCFLAGS="-O3 -mavx" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --disable-avx2 FC=mpif90 --enable-single-precision || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='1500 500 64' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran double precision mpi noomp AVX/SSE, no assumed size
gfortran-double-precision-mpi-noomp-no-assumed-size-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -mavx" FCFLAGS="-O3 -mavx" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --disable-avx2 FC=mpif90  --disable-assumed-size || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran single precision mpi noomp AVX/SSE, no assumed size
gfortran-single-precision-mpi-noomp-no-assumed-size-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -mavx" FCFLAGS="-O3 -mavx" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --disable-avx2 FC=mpif90 --enable-single-precision --disable-assumed-size || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;


# gfortran double precision mpi noomp AVX/SSE COVERAGE
gfortran-double-precision-mpi-noomp-coverage-avx-jobs:
  tags:
    - coverage
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx" FCFLAGS="--coverage -O3 -mavx" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --disable-avx2 FC=mpif90 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
  artifacts:
    paths:
      - coverage_data

gfortran-single-precision-mpi-noomp-coverage-avx-jobs:
  tags:
    - coverage
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx" FCFLAGS="--coverage -O3 -mavx" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --disable-avx2 FC=mpif90 --enable-single-precision || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
  artifacts:
    paths:
      - coverage_data

# gfortran double precision mpi noomp AVX/SSE, no assumed size COVERAGE
gfortran-double-precision-mpi-noomp-no-assumed-size-coverage-avx-jobs:
  tags:
    - coverage
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx" FCFLAGS="--coverage -O3 -mavx" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --disable-avx2 FC=mpif90 --disable-assumed-size || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
  artifacts:
    paths:
      - coverage_data

# gfortran single precision mpi noomp AVX/SSE no assumed size COVERAGE
gfortran-singe-precision-mpi-noomp-no-assumed-size-coverage-avx-jobs:
  tags:
    - coverage
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx" FCFLAGS="--coverage -O3 -mavx" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --disable-avx2 FC=mpif90 --enable-single-precision --disable-assumed-size || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
  artifacts:
    paths:
      - coverage_data


########################################################################################
#
# jobs for intel/gfortran double/single precision mpi and openmp no cuda SSE/AVX
# - all runners on "cpu"
# - including coverage runs
#
########################################################################################
# intel double precision mpi omp AVX/SSE
intel-double-precision-mpi-omp-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -mavx" FCFLAGS="-O3 -axAVX" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_OMP" --disable-avx2 --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export OMP_NUM_THREADS=2
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# intel double precision mpi omp AVX/SSE large
intel-double-precision-mpi-omp-large-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -mavx" FCFLAGS="-O3 -axAVX" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_OMP" --disable-avx2 --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export OMP_NUM_THREADS=2
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='1500 500 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# intel single precision mpi omp AVX/SSE
intel-single-precision-mpi-omp-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -mavx" FCFLAGS="-O3 -mavx" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_OMP" --enable-single-precision --disable-avx2 --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export OMP_NUM_THREADS=2
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran double precision mpi omp AVX/SSE
gfortran-double-precision-mpi-omp-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -mavx" FCFLAGS="-O3 -mavx" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" --disable-avx2 FC=mpif90 --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=2
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran single precision mpi omp AVX/SSE
gfortran-single-precision-mpi-omp-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -mavx" FCFLAGS="-O3 -mavx" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" --disable-avx2 FC=mpif90 --enable-single-precision --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran double precision mpi omp AVX/SSE debug
gfortran-double-precision-mpi-omp-debug-avx-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-g -O3 -mavx" FCFLAGS="-g -O3 -mavx" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" --disable-avx2 FC=mpif90 --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran single precision mpi omp AVX/SSE debug
gfortran-single-precision-mpi-omp-debug-avx-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-g -O3 -mavx" FCFLAGS="-g -O3 -mavx" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" --disable-avx2 FC=mpif90 --enable-single-precision --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;


# gfortran double precision mpi noomp AVX/SSE, no assumed size
gfortran-double-precision-mpi-omp-no-assumed-size-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -mavx" FCFLAGS="-O3 -mavx" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" --disable-avx2 FC=mpif90  --disable-assumed-size --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran double precision mpi noomp AVX/SSE, no assumed size debug
gfortran-double-precision-mpi-omp-no-assumed-size-debug-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-g -O3 -mavx" FCFLAGS="-g -O3 -mavx" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" --disable-avx2 FC=mpif90  --disable-assumed-size --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran single precision mpi omp AVX/SSE, no assumed size
gfortran-single-precision-mpi-omp-no-assumed-size-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O2 -mavx" FCFLAGS="-O2 -mavx" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" --disable-avx2 FC=mpif90 --enable-single-precision --disable-assumed-size --enable-openmp || { cat config.log; exit 1; }

    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;


# gfortran double precision mpi omp AVX/SSE COVERAGE
gfortran-double-precision-mpi-omp-coverage-avx-jobs:
  tags:
    - coverage
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O1 -mavx" FCFLAGS="--coverage -O1 -mavx" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" --disable-avx2 FC=mpif90 --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export OMP_NUM_THREADS=1
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
  artifacts:
    paths:
      - coverage_data

# gfortran single precision mpi omp AVX/SSE COVERAGE
gfortran-single-precision-mpi-omp-coverage-avx-jobs:
  tags:
    - coverage
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O0 -mavx" FCFLAGS="--coverage -O0 -mavx" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" --disable-avx2 FC=mpif90 --enable-single-precision --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
  artifacts:
    paths:
      - coverage_data

# gfortran double precision mpi omp AVX/SSE, no assumed size COVERAGE
gfortran-double-precision-mpi-omp-no-assumed-size-coverage-avx-jobs:
  tags:
    - coverage
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O0 -mavx" FCFLAGS="--coverage -O0 -mavx" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" --disable-avx2 FC=mpif90 --disable-assumed-size --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
  artifacts:
    paths:
      - coverage_data

# gfortran single precision mpi omp AVX/SSE no assumed size COVERAGE
gfortran-single-precision-mpi-omp-no-assumed-size-coverage-avx-jobs:
  tags:
    - coverage
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O1 -mavx" FCFLAGS="--coverage -O1 -mavx" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" --disable-avx2 FC=mpif90 --enable-single-precision --disable-assumed-size --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
  artifacts:
    paths:
      - coverage_data


########################################################################################
#
# jobs for intel/gfortran double/single precision nompi and no openmp no cuda SSE/AVX
# - all runners on "cpu"
# - including coverage runs
#
########################################################################################
# intel double precision nompi noomp AVX/SSE
intel-double-precision-nompi-noomp-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure FC=ifort --enable-option-checking=fatal CFLAGS="-O3 -mavx" FCFLAGS="-O3 -axAVX" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --disable-avx2 --with-mpi=0 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# intel double precision nompi noomp AVX/SSE large
intel-double-precision-nompi-noomp-large-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure FC=ifort --enable-option-checking=fatal CFLAGS="-O3 -mavx" FCFLAGS="-O3 -axAVX" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --disable-avx2 --with-mpi=0 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='1500 500 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# intel single precision nompi noomp AVX/SSE
intel-single-precision-nompi-noomp-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure FC=ifort --enable-option-checking=fatal CFLAGS="-O3 -mavx" FCFLAGS="-O3 -mavx" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --enable-single-precision --disable-avx2 --with-mpi=0 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran double precision nompi noomp AVX/SSE
gfortran-double-precision-nompi-noomp-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure FC=gfortran --enable-option-checking=fatal CFLAGS="-O3 -mavx -fsanitize=address" FCFLAGS="-O3 -mavx -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --disable-avx2 --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran single precision nompi noomp AVX/SSE
gfortran-single-precision-nompi-noomp-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure FC=gfortran --enable-option-checking=fatal CFLAGS="-O3 -mavx -fsanitize=address" FCFLAGS="-O3 -mavx -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --disable-avx2 --enable-single-precision --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran double precision nompi noomp AVX/SSE, no assumed size
gfortran-double-precision-nompi-noomp-no-assumed-size-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -mavx -fsanitize=address" FCFLAGS="-O3 -mavx -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --disable-avx2 FC=gfortran --disable-assumed-size  --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran single precision nompi noomp AVX/SSE, no assumed size
gfortran-single-precision-nompi-noomp-no-assumed-size-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure FC=gfortran --enable-option-checking=fatal CFLAGS="-O3 -mavx -fsanitize=address" FCFLAGS="-O3 -mavx -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --disable-avx2 --enable-single-precision --disable-assumed-size  --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;


# gfortran double precision nompi noomp AVX/SSE COVERAGE
gfortran-double-precision-nompi-noomp-coverage-avx-jobs:
  tags:
    - coverage
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx -fsanitize=address" FCFLAGS="--coverage -O3 -mavx -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --disable-avx2 FC=gfortran --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
  artifacts:
    paths:
      - coverage_data

# gfortran single precision nompi noomp AVX/SSE COVERAGE
gfortran-single-precision-nompi-noomp-coverage-avx-jobs:
  tags:
    - coverage
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx -fsanitize=address" FCFLAGS="--coverage -O3 -mavx -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --disable-avx2 FC=gfortran --enable-single-precision --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
  artifacts:
    paths:
      - coverage_data

# gfortran double precision nompi noomp AVX/SSE, no assumed size COVERAGE
gfortran-double-precision-nompi-noomp-no-assumed-size-coverage-avx-jobs:
  tags:
    - coverage
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx -fsanitize=address" FCFLAGS="--coverage -O3 -mavx -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --disable-avx2 FC=gfortran --disable-assumed-size  --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
  artifacts:
    paths:
      - coverage_data

# gfortran single precision nompi noomp AVX/SSE no assumed size COVERAGE
gfortran-single-precision-nompi-noomp-no-assumed-size-coverage-avx-jobs:
  tags:
    - coverage
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx -fsanitize=address" FCFLAGS="--coverage -O3 -mavx -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --disable-avx2 FC=gfortran --enable-single-precision --disable-assumed-size --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
  artifacts:
    paths:
      - coverage_data


########################################################################################
#
# jobs for intel/gfortran double/single precision nompi and openmp no cuda SSE/AVX
# - all runners on "cpu"
# - including coverage runs
#
########################################################################################
# intel double precision nompi omp AVX/SSE
intel-double-precision-nompi-omp-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure FC=ifort --enable-option-checking=fatal CFLAGS="-O3 -mavx" FCFLAGS="-O3 -axAVX" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_OMP" --disable-avx2 --enable-openmp --with-mpi=0 || { cat config.log; exit 1; }
    - make -j 8
    - export OMP_NUM_THREADS=2
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# intel double precision nompi omp AVX/SSE large
intel-double-precision-nompi-omp-large-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure FC=ifort --enable-option-checking=fatal CFLAGS="-O3 -mavx" FCFLAGS="-O3 -axAVX" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_OMP" --disable-avx2 --enable-openmp --with-mpi=0 || { cat config.log; exit 1; }
    - make -j 8
    - export OMP_NUM_THREADS=2
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='1500 500 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# intel single precision nompi omp AVX/SSE
intel-single-precision-nompi-omp-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure FC=ifort --enable-option-checking=fatal CFLAGS="-O3 -mavx" FCFLAGS="-O3 -mavx" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_OMP" --enable-single-precision --disable-avx2 --enable-openmp  --with-mpi=0 || { cat config.log; exit 1; }
    - make -j 8
    - export OMP_NUM_THREADS=2
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran double precision nompi omp AVX/SSE
gfortran-double-precision-nompi-omp-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -mavx -fsanitize=address" FCFLAGS="-O3 -mavx -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --disable-avx2 FC=gfortran --enable-openmp --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=2
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran single precision nompi omp AVX/SSE
gfortran-single-precision-nompi-omp-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -mavx -fsanitize=address" FCFLAGS="-O3 -mavx -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --disable-avx2 FC=gfortran --enable-single-precision --enable-openmp --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran double precision nompi omp AVX/SSE debug
gfortran-double-precision-nompi-omp-debug-avx-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-g -O3 -mavx -fsanitize=address" FCFLAGS="-g -O3 -mavx -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --disable-avx2 FC=gfortran --enable-openmp --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran single precision nompi omp AVX/SSE debug
gfortran-single-precision-nompi-omp-debug-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-g -O3 -mavx -fsanitize=address" FCFLAGS="-g -O3 -mavx -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --disable-avx2 FC=gfortran --enable-single-precision --enable-openmp --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;


# gfortran double precision nompi noomp AVX/SSE, no assumed size
gfortran-double-precision-nompi-omp-no-assumed-size-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -mavx -fsanitize=address" FCFLAGS="-O3 -mavx -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --disable-avx2 FC=gfortran  --disable-assumed-size --enable-openmp --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran double precision nompi noomp AVX/SSE, no assumed size debug
gfortran-double-precision-nompi-omp-no-assumed-size-debug-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-g -O3 -mavx -fsanitize=address" FCFLAGS="-g -O3 -mavx -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --disable-avx2 FC=gfortran  --disable-assumed-size --enable-openmp --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran single precision nompi omp AVX/SSE, no assumed size
gfortran-single-precision-nompi-omp-no-assumed-size-jobs:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O2 -mavx -fsanitize=address" FCFLAGS="-O2 -mavx -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --disable-avx2 FC=gfortran --enable-single-precision --disable-assumed-size --enable-openmp --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }

    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;


# gfortran double precision nompi omp AVX/SSE COVERAGE
gfortran-double-precision-nompi-omp-coverage-avx-jobs:
  tags:
    - coverage
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O1 -mavx -fsanitize=address" FCFLAGS="--coverage -O1 -mavx -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --disable-avx2 FC=gfortran --enable-openmp --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export OMP_NUM_THREADS=1
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
  artifacts:
    paths:
      - coverage_data

# gfortran single precision nompi omp AVX/SSE COVERAGE
gfortran-single-precision-nompi-omp-coverage-avx-jobs:
  tags:
    - coverage
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O0 -mavx -fsanitize=address" FCFLAGS="--coverage -O0 -mavx -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --disable-avx2 FC=gfortran --enable-single-precision --enable-openmp --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
  artifacts:
    paths:
      - coverage_data

# gfortran double precision nompi omp AVX/SSE, no assumed size COVERAGE
gfortran-double-precision-nompi-omp-no-assumed-size-coverage-avx-jobs:
  tags:
    - coverage
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O0 -mavx -fsanitize=address" FCFLAGS="--coverage -O0 -mavx -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --disable-avx2 FC=gfortran --disable-assumed-size --enable-openmp --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
  artifacts:
    paths:
      - coverage_data

# gfortran single precision nompi omp AVX/SSE no assumed size COVERAGE
gfortran-single-precision-nompi-omp-no-assumed-size-coverage-avx-jobs:
  tags:
    - coverage
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O1 -mavx -fsanitize=address" FCFLAGS="--coverage -O1 -mavx -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --disable-avx2 FC=gfortran --enable-single-precision --disable-assumed-size --enable-openmp --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
  artifacts:
    paths:
      - coverage_data



########################################################################################
#
# jobs for intel/gfortran double/single precision mpi and no openmp no cuda AVX2
# - all runners on "cpu"
# - including coverage runs
#
########################################################################################
# intel double precision mpi noomp AVX2
intel-double-precision-mpi-noomp-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -march=haswell -mavx2 -mfma" FCFLAGS="-O3 -axcore-AVX2" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_NO_OMP" || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='1500 500 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# intel double precision mpi noomp AVX2 large
intel-double-precision-mpi-noomp-large-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -march=haswell -mavx2 -mfma" FCFLAGS="-O3 -xcore-AVX2" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_NO_OMP" || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=8 TEST_FLAGS='1500 500 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# intel single precision mpi noomp AVX2
intel-single-precision-mpi-noomp-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -march=haswell -mavx2 -mfma" FCFLAGS="-O3 -xcore-AVX2" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_NO_OMP" --enable-single-precision || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran double precision mpi noomp AVX2
gfortran-double-precision-mpi-noomp-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -march=haswell -mavx2 -mfma" FCFLAGS="-O3 -march=haswell -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran single precision mpi noomp AVX2
gfortran-single-precision-mpi-noomp-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -march=haswell -mavx2 -mfma" FCFLAGS="-O3 -march=haswell -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --enable-single-precision || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran double precision mpi noomp AVX2, no assumed size
gfortran-double-precision-mpi-noomp-no-assumed-size-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -march=haswell -mavx2 -mfma" FCFLAGS="-O3 -march=haswell -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90  --disable-assumed-size || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran single precision mpi noomp AVX2, no assumed size
gfortran-single-precision-mpi-noomp-no-assumed-size-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -march=haswell -mavx2 -mfma" FCFLAGS="-O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --enable-single-precision --disable-assumed-size || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;



# gfortran double precision mpi noomp AVX2 coverage
gfortran-double-precision-mpi-noomp-avx2-coverage-jobs:
  tags:
    - avx2-coverage
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -march=haswell -mavx2 -mfma --coverage" FCFLAGS="--coverage -O3 -march=haswell -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
  artifacts:
    paths:
      - coverage_data


# gfortran single precision mpi noomp AVX2 coverage
gfortran-single-precision-mpi-noomp-avx2-coverage-jobs:
  tags:
    - avx2-coverage
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -march=haswell -mavx2 -mfma --coverage" FCFLAGS="--coverage -O3 -march=haswell -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --enable-single-precision FC=mpif90 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export ELPA_FORCE_complex_kernel=ELPA_2STAGE_COMPLEX_AVX2_BLOCK1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
  artifacts:
    paths:
      - coverage_data

      ## gfortran double precision mpi noomp AVX2, no assumed size COVERAGE
      #gfortran-double-precision-mpi-noomp-no-assumed-size-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --disable-assumed-size || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran single precision mpi noomp AVX2 no assumed size COVERAGE
      #gfortran-double-precision-mpi-noomp-no-assumed-size-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --enable-single-precision --disable-assumed-size || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data



########################################################################################
#
# jobs for intel/gfortran double/single precision mpi and openmp no cuda AVX2
# - all runners on "cpu"
# - including coverage runs
#
########################################################################################
# intel double precision mpi omp AVX2
intel-double-precision-mpi-omp-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-march=haswell -O3 -mavx2" FCFLAGS="-O3 -xCORE-AVX2" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_OMP" --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export OMP_NUM_THREADS=2
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# intel double precision mpi omp AVX2 large
intel-double-precision-mpi-omp-large-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -mavx2 -mfma" FCFLAGS="-O3 -axAVX2" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_OMP" --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export OMP_NUM_THREADS=2
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='1500 500 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# intel single precision mpi omp AVX2
intel-single-precision-mpi-omp-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -march=haswell -mavx2 -mfma" FCFLAGS="-O3 -xCORE-AVX2" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_OMP" --enable-single-precision --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export OMP_NUM_THREADS=2
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran double precision mpi omp AVX2
gfortran-double-precision-mpi-omp-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-march=haswell -O3 -mavx2 -mfma" FCFLAGS="-O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" FC=mpif90 --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=2
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran single precision mpi omp AVX2
gfortran-single-precision-mpi-omp-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-march=haswell -O3 -mavx2 -mfma" FCFLAGS="-march=haswell -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" FC=mpif90 --enable-single-precision --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=2
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran double precision mpi omp AVX2 debug
gfortran-double-precision-mpi-omp-debug-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-g -march=haswell -O3 -mavx" FCFLAGS="-march=haswell -g -O3 -mavx" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" --disable-avx2 FC=mpif90 --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran single precision mpi omp AVX2 debug
gfortran-single-precision-mpi-omp-debug-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-march=haswell -g -O3 -mavx2 -mfma" FCFLAGS="-g -O3 -march=haswell  -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" FC=mpif90 --enable-single-precision --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;


# gfortran double precision mpi noomp AVX2, no assumed size
gfortran-double-precision-mpi-omp-no-assumed-size-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -march=haswell -mavx2 -mfma" FCFLAGS="-march=haswell -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" FC=mpif90  --disable-assumed-size --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }

    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran double precision mpi noomp AVX2, no assumed size debug
gfortran-double-precision-mpi-omp-no-assumed-size-debug-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-g -O3 -march=haswell -mavx2 -mfma" FCFLAGS="-g -march=haswell -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" FC=mpif90  --disable-assumed-size --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran single precision mpi omp AVX2, no assumed size
gfortran-single-precision-mpi-omp-no-assumed-size-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O2 -march=haswell -mavx2 -mfma" FCFLAGS="-O2 -march=haswell -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" FC=mpif90 --enable-single-precision --disable-assumed-size --enable-openmp || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

      # no coverage on tag avx2
      #
      ## gfortran double precision mpi omp AVX2 COVERAGE
      #gfortran-double-precision-mpi-omp-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O1 -mavx2 -mfma" FCFLAGS="--coverage -O1 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP"  FC=mpif90 --enable-openmp || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export OMP_NUM_THREADS=1
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran single precision mpi omp AVX2 COVERAGE
      #gfortran-double-precision-mpi-omp-coverage-AVX2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O0 -mavx2 -mfma" FCFLAGS="--coverage -O0 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" FC=mpif90 --enable-single-precision --enable-openmp || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - export OMP_NUM_THREADS=1
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran double precision mpi omp AVX2, no assumed size COVERAGE
      #gfortran-double-precision-mpi-omp-no-assumed-size-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O0 -mavx2 -mfma" FCFLAGS="--coverage -O0 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" FC=mpif90 --disable-assumed-size --enable-openmp || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - export OMP_NUM_THREADS=1
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran single precision mpi omp AVX2 no assumed size COVERAGE
      #gfortran-double-precision-mpi-omp-no-assumed-size-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O1 -mavx2 -mfma" FCFLAGS="--coverage -O1 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" FC=mpif90 --enable-single-precision --disable-assumed-size --enable-openmp || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - export OMP_NUM_THREADS=1
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data




########################################################################################
#
# jobs for intel/gfortran double/single precision nompi and no openmp no cuda AVX2
# - all runners on "cpu"
# - including coverage runs
#
########################################################################################
# intel double precision nompi noomp AVX2
intel-double-precision-nompi-noomp-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure FC=ifort --enable-option-checking=fatal CFLAGS="-march=haswell -O3 -mavx2 -mfma" FCFLAGS="-O3 -xCORE-AVX2" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --with-mpi=0 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# intel double precision nompi noomp AVX2 large
intel-double-precision-nompi-noomp-large-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure FC=ifort --enable-option-checking=fatal CFLAGS="-O3 -march=haswell -mavx2 -mfma" FCFLAGS="-O3 -xCORE-AVX2" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --with-mpi=0 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# intel single precision nompi noomp AVX2
intel-single-precision-nompi-noomp-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure FC=ifort --enable-option-checking=fatal CFLAGS="-march=haswell -O3 -mavx2 -mfma" FCFLAGS="-O3 -xCORE-AVX2" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --enable-single-precision --with-mpi=0 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran double precision nompi noomp AVX2
gfortran-double-precision-nompi-noomp-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure FC=gfortran --enable-option-checking=fatal CFLAGS="-march=haswell -O3 -mavx2 -mfma -fsanitize=address" FCFLAGS="-march=haswell -O3 -mavx2 -mfma -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" FC=gfortran  --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran single precision nompi noomp AVX2
gfortran-single-precision-nompi-noomp-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure FC=gfortran --enable-option-checking=fatal CFLAGS="-O3 -march=haswell -mavx2 -mfma -fsanitize=address" FCFLAGS="-O3 -mavx2 -march=haswell -mfma -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --enable-single-precision --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran double precision nompi noomp AVX2, no assumed size
gfortran-double-precision-nompi-noomp-no-assumed-size-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-march=haswell -O3 -mavx2 -mfma -fsanitize=address" FCFLAGS="-march=haswell -O3 -mavx2 -mfma -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" FC=gfortran  --disable-assumed-size  --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran single precision nompi noomp AVX2, no assumed size
gfortran-single-precision-nompi-noomp-no-assumed-size-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure FC=gfortran --enable-option-checking=fatal CFLAGS="-march=haswell -O3 -mavx2 -mfma -fsanitize=address" FCFLAGS="-march=haswell -O3 -mavx2 -mfma -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" FC=gfortran --enable-single-precision --disable-assumed-size  --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

      # no coverage with tag avx2
      #
      ## gfortran double precision nompi noomp AVX2 COVERAGE
      #gfortran-double-precision-nompi-noomp-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma -fsanitize=address" FCFLAGS="--coverage -O3 -mavx2 -mfma -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" FC=gfortran --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran single precision nompi noomp AVX2 COVERAGE
      #gfortran-double-precision-nompi-noomp-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma -fsanitize=address" FCFLAGS="--coverage -O3 -mavx2 -mfma -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" FC=gfortran --enable-single-precision --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran double precision nompi noomp AVX2, no assumed size COVERAGE
      #gfortran-double-precision-nompi-noomp-no-assumed-size-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma -fsanitize=address" FCFLAGS="--coverage -O3 -mavx2 -mfma -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" FC=gfortran --disable-assumed-size  --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran single precision nompi noomp AVX2 no assumed size COVERAGE
      #gfortran-double-precision-nompi-noomp-no-assumed-size-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma -fsanitize=address" FCFLAGS="--coverage -O3 -mavx2 -mfma -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" FC=gfortran --enable-single-precision --disable-assumed-size --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data





########################################################################################
#
# jobs for intel/gfortran double/single precision nompi and openmp no cuda AVX2
# - all runners on "cpu"
# - including coverage runs
#
########################################################################################
# intel double precision nompi omp AVX2
intel-double-precision-nompi-omp-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure FC=ifort --enable-option-checking=fatal CFLAGS="-march=haswell -O3 -mavx2 -mfma" FCFLAGS="-O3 -xCORE-AVX2" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_OMP" --enable-openmp --with-mpi=0 || { cat config.log; exit 1; }
    - make -j 8
    - export OMP_NUM_THREADS=2
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# intel double precision nompi omp AVX2 large
intel-double-precision-nompi-omp-large-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure FC=ifort --enable-option-checking=fatal CFLAGS="-march=haswell -O3 -mavx2 -mfma" FCFLAGS="-O3 -xCORE-AVX2" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_OMP" --enable-openmp --with-mpi=0 || { cat config.log; exit 1; }
    - make -j 8
    - export OMP_NUM_THREADS=2
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# intel single precision nompi omp AVX2
intel-single-precision-nompi-omp-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure FC=ifort --enable-option-checking=fatal CFLAGS="-march=haswell -O3 -mavx2 -mfma" FCFLAGS="-O3 -xCORE-AVX2" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_OMP" --enable-single-precision --enable-openmp  --with-mpi=0 || { cat config.log; exit 1; }
    - make -j 8
    - export OMP_NUM_THREADS=2
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran double precision nompi omp AVX2
gfortran-double-precision-nompi-omp-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-march=haswell -O3 -mavx2 -mfma -fsanitize=address" FCFLAGS="-march=haswell -O3 -mavx2 -mfma -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" FC=gfortran --enable-openmp --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=2
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran single precision nompi omp AVX2
gfortran-single-precision-nompi-omp-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -march=haswell -mavx2 -mfma -fsanitize=address" FCFLAGS="-O3 -march=haswell -mavx2 -mfma -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" FC=gfortran --enable-single-precision --enable-openmp --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran double precision nompi omp AVX2 debug
gfortran-double-precision-nompi-omp-debug-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-march=haswell -g -O3 -mavx2 -mfma -fsanitize=address" FCFLAGS="-march=haswell -g -O3 -mavx2 -mfma -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" FC=gfortran  --enable-openmp --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran single precision nompi omp AVX2
gfortran-single-precision-nompi-omp-debug-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-g -march=haswell -O3 -mavx2 -mfma -fsanitize=address" FCFLAGS=" -march=haswell -g -O3 -mavx2 -mfma -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP"  FC=gfortran --enable-single-precision --enable-openmp --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;


# gfortran double precision nompi noomp AVX2, no assumed size
gfortran-double-precision-nompi-omp-no-assumed-size-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-march=haswell -O3 -mavx2 -mfma -fsanitize=address" FCFLAGS="-march=haswell -O3 -mavx2 -mfma -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP"  FC=gfortran  --disable-assumed-size --enable-openmp --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran double precision nompi noomp AVX2, no assumed size debug
gfortran-double-precision-nompi-omp-no-assumed-size-debug-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-g -march=haswell -O3 -mavx2 -mfma -fsanitize=address" FCFLAGS="-march=haswell -g -O3 -mavx2 -mfma -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" FC=gfortran  --disable-assumed-size --enable-openmp --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# gfortran single precision nompi omp AVX2, no assumed size
gfortran-single-precision-nompi-omp-no-assumed-size-avx2-jobs:
  tags:
    - avx2
  script:
    - ./autogen.sh
    - ./configure FC=gfortran --enable-option-checking=fatal CFLAGS="-O2 -march=haswell  -mavx2 -mfma -fsanitize=address" FCFLAGS="-march=haswell -O2 -mavx2 -mfma -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --enable-single-precision --disable-assumed-size --enable-openmp --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }

    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

      # no coverage on tag avx2
      #
      ## gfortran double precision nompi omp AVX2 COVERAGE
      #gfortran-double-precision-nompi-omp-coverage-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O1 -mavx2 -march=haswell -mfma -fsanitize=address" FCFLAGS="--coverage -O1 -mavx2 -mfma -march=haswell -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --disable-avx2 FC=gfortran --enable-openmp --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export OMP_NUM_THREADS=1
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran single precision nompi omp AVX/SSE COVERAGE
      #gfortran-double-precision-nompi-omp-coverage-jobs:
      #  tags:
      #    - coverage
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O0 -mavx -fsanitize=address" FCFLAGS="--coverage -O0 -mavx -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --disable-avx2 FC=gfortran --enable-single-precision --enable-openmp --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - export OMP_NUM_THREADS=1
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran double precision nompi omp AVX/SSE, no assumed size COVERAGE
      #gfortran-double-precision-nompi-omp-no-assumed-size-coverage-jobs:
      #  tags:
      #    - coverage
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O0 -mavx -fsanitize=address" FCFLAGS="--coverage -O0 -mavx -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --disable-avx2 FC=gfortran --disable-assumed-size --enable-openmp --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - export OMP_NUM_THREADS=1
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran single precision nompi omp AVX/SSE no assumed size COVERAGE
      #gfortran-double-precision-nompi-omp-no-assumed-size-coverage-jobs:
      #  tags:
      #    - coverage
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O1 -mavx -fsanitize=address" FCFLAGS="--coverage -O1 -mavx -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --disable-avx2 FC=gfortran --enable-single-precision --disable-assumed-size --enable-openmp --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - export OMP_NUM_THREADS=1
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data





########################################################################################
#
# jobs for intel/gfortran double/single precision CUDA
# - all runners on "cpu"
# - including coverage runs
#
########################################################################################

gfortran-double-precision-mpi-noomp-gpu-coverage-jobs:
  tags:
    - gpu-coverage
  script:
    - module unload gcc
    - module load gcc/4.9 cuda
    - module list
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O2" FCFLAGS="--coverage -O1" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" --enable-gpu --with-cuda-path=$CUDA_HOME/ --disable-assumed-size --disable-sse --disable-sse-assembly --disable-avx --disable-avx2 FC=mpif90 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot)
    - make check TASKS=2 TEST_FLAGS='500 500 128' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
    - gpschedule -d $GPJOBID
  artifacts:
    paths:
      - coverage_data

gfortran-single-precision-mpi-noomp-gpu-coverage-jobs:
  tags:
    - gpu-coverage
  script:
    - module unload gcc
    - module load gcc/4.9 cuda
    - module list
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O2" FCFLAGS="--coverage -O1" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" --enable-gpu --with-cuda-path=$CUDA_HOME/ --disable-assumed-size --disable-sse --disable-sse-assembly --disable-avx --disable-avx2 FC=mpif90 --enable-single-precision || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot)
    - make check TASKS=2 TEST_FLAGS='500 500 128' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
    - gpschedule -d $GPJOBID
  artifacts:
    paths:
      - coverage_data

intel-double-precision-mpi-noomp-cuda-jobs-blocksize-32:
  tags:
    - gpu
  script:
    - module unload gcc
    - module load gcc/4.9 cuda
    - module list
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" CFLAGS="-O2"  FCFLAGS="-O1" --enable-gpu --with-cuda-path=$CUDA_HOME/ --disable-assumed-size --disable-sse --disable-sse-assembly --disable-avx --disable-avx2 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot)
    - make check TASKS=2 TEST_FLAGS='150 50 32' || { cat test-suite.log; exit 1; }
    - cat test-suite.log
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID


gfortran-double-precision-mpi-noomp-gpu-coverage-blocksize-32-jobs:
  tags:
    - gpu-coverage
  script:
    - module unload gcc
    - module load gcc/4.9 cuda
    - module list
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O2" FCFLAGS="--coverage -O1" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" --enable-gpu --with-cuda-path=$CUDA_HOME/ --disable-assumed-size --disable-sse --disable-sse-assembly --disable-avx --disable-avx2 FC=mpif90 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot)
    - make check TASKS=2 TEST_FLAGS='150 50 32' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
    - gpschedule -d $GPJOBID
  artifacts:
    paths:
      - coverage_data

gfortran-single-precision-mpi-noomp-gpu-coverage-blocksize-32-jobs:
  tags:
    - gpu-coverage
  script:
    - module unload gcc
    - module load gcc/4.9 cuda
    - module list
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O2" FCFLAGS="--coverage -O1" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" --enable-gpu --with-cuda-path=$CUDA_HOME/ --disable-assumed-size --disable-sse --disable-sse-assembly --disable-avx --disable-avx2 --enable-single-precision FC=mpif90 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot)
    - make check TASKS=2 TEST_FLAGS='150 50 32' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
    - gpschedule -d $GPJOBID
  artifacts:
    paths:
      - coverage_data



intel-double-precision-mpi-noomp-cuda-jobs-blocksize-16:
  tags:
    - gpu
  script:
    - module unload gcc
    - module load gcc/4.9 cuda
    - module list
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" CFLAGS="-O2"  FCFLAGS="-O1" --enable-gpu --with-cuda-path=$CUDA_HOME/ --disable-assumed-size --disable-sse --disable-sse-assembly --disable-avx --disable-avx2 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot)
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - cat test-suite.log
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID


gfortran-double-precision-nompi-noomp-gpu-coverage-jobs:
  tags:
    - gpu-coverage
  script:
    - module unload gcc
    - module load gcc/4.9 cuda
    - module list
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O2" FCFLAGS="--coverage -O1" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" --enable-gpu --with-cuda-path=$CUDA_HOME/ --disable-assumed-size --disable-sse --disable-sse-assembly --disable-avx --disable-avx2 FC=gfortran --with-mpi=0 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot)
    - make check TASKS=2 TEST_FLAGS='1500 500 128' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
    - gpschedule -d $GPJOBID
  artifacts:
    paths:
      - coverage_data

gfortran-single-precision-nompi-noomp-gpu-coverage-jobs:
  tags:
    - gpu-coverage
  script:
    - module unload gcc
    - module load gcc/4.9 cuda
    - module list
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O2" FCFLAGS="--coverage -O1" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" --enable-gpu --with-cuda-path=$CUDA_HOME/ --disable-assumed-size --disable-sse --disable-sse-assembly --disable-avx --disable-avx2 FC=gfortran --with-mpi=0 --enable-single-precision || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot)
    - make check TASKS=2 TEST_FLAGS='1500 500 128' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
    - gpschedule -d $GPJOBID
  artifacts:
    paths:
      - coverage_data
intel-double-precision-nompi-noomp-cuda-jobs:
  tags:
    - gpu
  script:
    - module unload gcc
    - module load gcc/4.9 cuda
    - module list
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal FC=ifort SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" CFLAGS="-O2"  FCFLAGS="-O1" --enable-gpu --with-cuda-path=$CUDA_HOME/ --with-mpi=0  --disable-sse --disable-sse-assembly --disable-avx --disable-avx2 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot)
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - cat test-suite.log
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

intel-single-precision-mpi-noomp-cuda-jobs:
  tags:
    - gpu
  script:
    - module unload gcc
    - module load gcc/4.9 cuda
    - module list
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" CFLAGS="-O2"  FCFLAGS="-O1" --enable-gpu --with-cuda-path=$CUDA_HOME/ --enable-single-precision  --disable-sse --disable-sse-assembly --disable-avx --disable-avx2 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot)
    - make check TASKS=2 TEST_FLAGS='150 50 128' || { cat test-suite.log; exit 1; }
    - cat test-suite.log
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

intel-single-precision-mpi-noomp-cuda-jobs-blocksize-64:
  tags:
    - gpu
  script:
    - module unload gcc
    - module load gcc/4.9 cuda
    - module list
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" CFLAGS="-O2"  FCFLAGS="-O1" --enable-gpu --with-cuda-path=$CUDA_HOME/ --enable-single-precision  --disable-sse --disable-sse-assembly --disable-avx --disable-avx2 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot)
    - make check TASKS=2 TEST_FLAGS='150 50 64' || { cat test-suite.log; exit 1; }
    - cat test-suite.log
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID


intel-single-precision-mpi-noomp-cuda-larger-jobs:
  tags:
    - gpu
  script:
    - module unload gcc
    - module load gcc/4.9 cuda
    - module list
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" CFLAGS="-O2"  FCFLAGS="-O1" --enable-gpu --with-cuda-path=$CUDA_HOME/ --enable-single-precision  --disable-sse --disable-sse-assembly --disable-avx --disable-avx2 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot)
    - make check TASKS=2 TEST_FLAGS='1500 500 128' || { cat test-suite.log; exit 1; }
    - cat test-suite.log
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID


intel-single-precision-nompi-noomp-cuda-jobs:
  tags:
    - gpu
  script:
    - module unload gcc
    - module load gcc/4.9 cuda
    - module list
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal FC=ifort SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" CFLAGS="-O2"  FCFLAGS="-O1" --enable-gpu --with-cuda-path=$CUDA_HOME/ --enable-single-precision --with-mpi=0  --disable-sse --disable-sse-assembly --disable-avx --disable-avx2 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot)
    - make check TASKS=2 TEST_FLAGS='150 50 128' || { cat test-suite.log; exit 1; }
    - cat test-suite.log
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

intel-single-precision-nompi-noomp-cuda-larger-jobs:
  tags:
    - gpu
  script:
    - module unload gcc
    - module load gcc/4.9 cuda
    - module list
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal FC=ifort SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP -L$CUDA_HOME/lib64 -lcublas -I$CUDA_HOME/include" CFLAGS="-O2"  FCFLAGS="-O1" --enable-gpu --with-cuda-path=$CUDA_HOME/ --enable-single-precision --with-mpi=0  --disable-sse --disable-sse-assembly --disable-avx --disable-avx2 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot)
    - make check TASKS=2 TEST_FLAGS='1500 500 128' || { cat test-suite.log; exit 1; }
    - cat test-suite.log
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID


########################################################################################
#
# jobs for intel/gfortran double/single precision mpi and no openmp no cuda KNL
# - all runners on "cpu"
# - including coverage runs
#
########################################################################################
# intel double precision mpi noomp AVX512
intel-double-precision-mpi-noomp-avx512-jobs:
  tags:
    - KNL
  script:
    - ./autogen.sh
    - export MKL_INTEL_SCALAPACK_LDFLAGS_MPI_NO_OMP="-L$MKLROOT/lib/intel64 -lmkl_scalapack_lp64 -lmkl_intel_lp64 -lmkl_sequential -lmkl_core -lmkl_blacs_intelmpi_lp64 -lpthread  -Wl,-rpath,$MKLROOT/lib/intel64"
    - export MKL_INTEL_SCALAPACK_FCFLAGS_MPI_NO_OMP="-I$MKLROOT/include/intel64/lp64"
    - ./configure  FC=mpiifort CC=mpiicc --enable-option-checking=fatal CFLAGS="-O3 -mtune=knl -xMIC-AVX512" FCFLAGS="-O3 -axMIC-AVX512" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_NO_OMP" --enable-avx512 || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 2000 )
    - make -j 8
    - export LD_LIBRARY_PATH=$MKLROOT/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# intel double precision mpi noomp AVX512 large
intel-double-precision-mpi-noomp-large-avx512-jobs:
  tags:
    - KNL
  script:
    - ./autogen.sh
    - export MKL_INTEL_SCALAPACK_LDFLAGS_MPI_NO_OMP="-L$MKLROOT/lib/intel64 -lmkl_scalapack_lp64 -lmkl_intel_lp64 -lmkl_sequential -lmkl_core -lmkl_blacs_intelmpi_lp64 -lpthread  -Wl,-rpath,$MKLROOT/lib/intel64"
    - export MKL_INTEL_SCALAPACK_FCFLAGS_MPI_NO_OMP="-I$MKLROOT/include/intel64/lp64"
    - ./configure  FC=mpiifort CC=mpiicc --enable-option-checking=fatal CFLAGS="-O3 -mtune=knl -xMIC-AVX512" FCFLAGS="-O3 -axMIC-AVX512" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_NO_OMP" --enable-avx512 || { cat config.log; exit 1; }
      #    - /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 3600 )
    - make -j 8
    - export LD_LIBRARY_PATH=$MKLROOT/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='1500 500 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# intel single precision mpi noomp AVX512
intel-single-precision-mpi-noomp-avx512-jobs:
  tags:
    - KNL
  script:
    - ./autogen.sh
    - export MKL_INTEL_SCALAPACK_LDFLAGS_MPI_NO_OMP="-L$MKLROOT/lib/intel64 -lmkl_scalapack_lp64 -lmkl_intel_lp64 -lmkl_sequential -lmkl_core -lmkl_blacs_intelmpi_lp64 -lpthread -Wl,-rpath,$MKLROOT/lib/intel64"
    - export MKL_INTEL_SCALAPACK_FCFLAGS_MPI_NO_OMP="-I$MKLROOT/include/intel64/lp64"
    - ./configure  FC=mpiifort CC=mpiicc --enable-option-checking=fatal CFLAGS="-O3 -mtune=knl -xMIC-AVX512" FCFLAGS="-O3 -axMIC-AVX512" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_NO_OMP" --enable-avx512 --enable-single-precision || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 3600 )
    - make -j 8
    - export LD_LIBRARY_PATH=$MKLROOT/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran double precision mpi noomp AVX512
gfortran-double-precision-mpi-noomp-avx512-jobs:
  tags:
    - KNL
  script:
    - ./autogen.sh
    - export MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP="-L$MKLROOT/lib/intel64 -lmkl_scalapack_lp64 -lmkl_gf_lp64 -lmkl_sequential -lmkl_core -lmkl_blacs_intelmpi_lp64 -lpthread  -Wl,-rpath,$MKLROOT/lib/intel64"
    - export MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP="-I$MKLROOT/include/intel64/lp64"
    - ./configure  FC=mpif90 CC=mpicc --enable-option-checking=fatal CFLAGS="-O3 -march=native" FCFLAGS="-O3 -march=native" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --enable-avx512 || { cat config.log; exit 1; }
      # - /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 2000 )
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran single precision mpi noomp AVX512
gfortran-single-precision-mpi-noomp-avx512-jobs:
  tags:
    - KNL
  script:
    - ./autogen.sh
    - export MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP="-L$MKLROOT/lib/intel64 -lmkl_scalapack_lp64 -lmkl_gf_lp64 -lmkl_sequential -lmkl_core -lmkl_blacs_intelmpi_lp64 -lpthread  -Wl,-rpath,$MKLROOT/lib/intel64"
    - export MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP="-I$MKLROOT/include/intel64/lp64"
    - ./configure  FC=mpif90 CC=mpicc --enable-option-checking=fatal CFLAGS="-O3 -march=native" FCFLAGS="-O3 -march=native" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --enable-avx512 --enable-single-precision || { cat config.log; exit 1; }
      # - /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 2000 )
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran double precision mpi noomp AVX512, no assumed size
gfortran-double-precision-mpi-noomp-no-assumed-size-avx512-jobs:
  tags:
    - KNL
  script:
    - ./autogen.sh
    - export MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP="-L$MKLROOT/lib/intel64 -lmkl_scalapack_lp64 -lmkl_gf_lp64 -lmkl_sequential -lmkl_core -lmkl_blacs_intelmpi_lp64 -lpthread  -Wl,-rpath,$MKLROOT/lib/intel64"
    - export MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP="-I$MKLROOT/include/intel64/lp64"
    - ./configure  FC=mpif90 CC=mpicc --enable-option-checking=fatal CFLAGS="-O3 -march=native" FCFLAGS="-O3 -march=native" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --enable-avx512 --disable-assumed-size || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 2000 )
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran single precision mpi noomp AVX512, no assumed size
gfortran-single-precision-mpi-noomp-no-assumed-size-avx512-jobs:
  tags:
    - KNL
  script:
    - ./autogen.sh
    - export MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP="-L$MKLROOT/lib/intel64 -lmkl_scalapack_lp64 -lmkl_gf_lp64 -lmkl_sequential -lmkl_core -lmkl_blacs_intelmpi_lp64 -lpthread  -Wl,-rpath,$MKLROOT/lib/intel64"
    - export MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP="-I$MKLROOT/include/intel64/lp64"
    - ./configure  FC=mpif90 CC=mpicc --enable-option-checking=fatal CFLAGS="-O3 -march=native" FCFLAGS="-O3 -march=native" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --enable-avx512 --disable-assumed-size --enable-single-precision || { cat config.log; exit 1; }
      # - /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 2000 )
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

      # no coverage on system with tag AVX2
      #
      ## gfortran double precision mpi noomp AVX2 COVERAGE
      #gfortran-double-precision-mpi-noomp-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran single precision mpi noomp AVX2 COVERAGE
      #gfortran-double-precision-mpi-noomp-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --enable-single-precision || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran double precision mpi noomp AVX2, no assumed size COVERAGE
      #gfortran-double-precision-mpi-noomp-no-assumed-size-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --disable-assumed-size || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran single precision mpi noomp AVX2 no assumed size COVERAGE
      #gfortran-double-precision-mpi-noomp-no-assumed-size-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --enable-single-precision --disable-assumed-size || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data



########################################################################################
#
# jobs for intel/gfortran double/single precision nompi and no openmp no cuda KNL
# - all runners on "cpu"
# - including coverage runs
#
########################################################################################
# intel double precision no mpi noomp AVX512
intel-double-precision-no-mpi-noomp-avx512-jobs:
  tags:
    - KNL
  script:
    - ./autogen.sh
    - export MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP="-L$MKLROOT/lib/intel64 -lmkl_intel_lp64 -lmkl_sequential -lmkl_core -lpthread -Wl,-rpath,$MKLROOT/lib/intel64"
    - export MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP="-I$MKLROOT/include/intel64/lp64"
    - ./configure  FC=ifort CC=icc --enable-option-checking=fatal CFLAGS="-O3 -mtune=knl -xMIC-AVX512" FCFLAGS="-O3 -axMIC-AVX512" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --enable-avx512 --with-mpi=0 || { cat config.log; exit 1; }
      # - /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 2000 )
    - make -j 8
    - export LD_LIBRARY_PATH=$MKLROOT/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# intel double precision no mpi noomp AVX512 large
intel-double-precision-no-mpi-noomp-large-avx512-jobs:
  tags:
    - KNL
  script:
    - ./autogen.sh
    - export MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP="-L$MKLROOT/lib/intel64 -lmkl_intel_lp64 -lmkl_sequential -lmkl_core -lpthread -Wl,-rpath,$MKLROOT/lib/intel64"
    - export MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP="-I$MKLROOT/include/intel64/lp64"
    - ./configure  FC=ifort CC=icc --enable-option-checking=fatal CFLAGS="-O3 -mtune=knl -xMIC-AVX512" FCFLAGS="-O3 -axMIC-AVX512" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --enable-avx512 --with-mpi=0 || { cat config.log; exit 1; }
      # - /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 2000 )
    - make -j 8
    - export LD_LIBRARY_PATH=$MKLROOT/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# intel single precision no mpi noomp AVX512
intel-single-precision-no-mpi-noomp-avx512-jobs:
  tags:
    - KNL
  script:
    - ./autogen.sh
    - export MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP="-L$MKLROOT/lib/intel64 -lmkl_intel_lp64 -lmkl_sequential -lmkl_core -lpthread -Wl,-rpath,$MKLROOT/lib/intel64"
    - export MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP="-I$MKLROOT/include/intel64/lp64"
    - ./configure  FC=ifort CC=icc --enable-option-checking=fatal CFLAGS="-O3 -mtune=knl -xMIC-AVX512" FCFLAGS="-O3 -axMIC-AVX512" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --enable-avx512 --with-mpi=0 --enable-single-precision || { cat config.log; exit 1; }
      # - /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 4000 )
    - make -j 8
    - export LD_LIBRARY_PATH=$MKLROOT/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran double precision no mpi noomp AVX512
gfortran-double-precision-no-mpi-noomp-AVX512-jobs:
  tags:
    - KNL
  script:
    - ./autogen.sh
    - export MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP="-L$MKLROOT/lib/intel64 -lmkl_gf_lp64 -lmkl_sequential -lmkl_core -lpthread -Wl,-rpath,$MKLROOT/lib/intel64"
    - export MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP="-I$MKLROOT/include/intel64/lp64"
    - ./configure  FC=gfortran CC=gcc --enable-option-checking=fatal CFLAGS="-O3 -march=native -fsanitize=address" FCFLAGS="-O3 -march=native -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --enable-avx512 --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
      # - /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 2000 )
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran single precision no mpi noomp AVX512
gfortran-single-precision-no-mpi-noomp-avx512-jobs:
  tags:
    - KNL
  script:
    - ./autogen.sh
    - export MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP="-L$MKLROOT/lib/intel64 -lmkl_gf_lp64 -lmkl_sequential -lmkl_core -lpthread -Wl,-rpath,$MKLROOT/lib/intel64"
    - export MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP="-I$MKLROOT/include/intel64/lp64"
    - ./configure  FC=gfortran CC=gcc --enable-option-checking=fatal CFLAGS="-O3 -march=native -fsanitize=address" FCFLAGS="-O3 -march=native -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --enable-avx512 --with-mpi=0 --disable-mpi-module --enable-single-precision || { cat config.log; exit 1; }
      # - /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 2000 )
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran double precision no mpi noomp AVX512, no assumed size
gfortran-double-precision-no-mpi-noomp-no-assumed-size-avx512-jobs:
  tags:
    - KNL
  script:
    - ./autogen.sh
    - export MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP="-L$MKLROOT/lib/intel64 -lmkl_gf_lp64 -lmkl_sequential -lmkl_core -lpthread -Wl,-rpath,$MKLROOT/lib/intel64"
    - export MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP="-I$MKLROOT/include/intel64/lp64"
    - ./configure  FC=gfortran CC=gcc --enable-option-checking=fatal CFLAGS="-O3 -march=native -fsanitize=address" FCFLAGS="-O3 -march=native -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --enable-avx512 --with-mpi=0 --disable-mpi-module --disable-assumed-size || { cat config.log; exit 1; }
      # - /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 2000 )
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran single precision no-mpi noomp AVX512, no assumed size
gfortran-single-precision-no-mpi-noomp-no-assumed-size-avx512-jobs:
  tags:
    - KNL
  script:
    - ./autogen.sh
    - export MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP="-L$MKLROOT/lib/intel64 -lmkl_gf_lp64 -lmkl_sequential -lmkl_core -lpthread -Wl,-rpath,$MKLROOT/lib/intel64"
    - export MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP="-I$MKLROOT/include/intel64/lp64"
    - ./configure  FC=gfortran CC=gcc --enable-option-checking=fatal CFLAGS="-O3 -march=native -fsanitize=address" FCFLAGS="-O3 -march=native -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --enable-avx512 --with-mpi=0 --disable-mpi-module --disable-assumed-size --enable-single-precision || { cat config.log; exit 1; }
      # - /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 2000 )
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

      # no coverage on system with tag AVX2
      #
      ## gfortran double precision mpi noomp AVX2 COVERAGE
      #gfortran-double-precision-mpi-noomp-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran single precision mpi noomp AVX2 COVERAGE
      #gfortran-double-precision-mpi-noomp-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --enable-single-precision || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran double precision mpi noomp AVX2, no assumed size COVERAGE
      #gfortran-double-precision-mpi-noomp-no-assumed-size-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --disable-assumed-size || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran single precision mpi noomp AVX2 no assumed size COVERAGE
      #gfortran-double-precision-mpi-noomp-no-assumed-size-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --enable-single-precision --disable-assumed-size || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data



########################################################################################
#
# jobs for intel/gfortran double/single precision nompi and openmp no cuda KNL
# - all runners on "cpu"
# - including coverage runs
#
########################################################################################
# intel double precision no mpi noomp AVX512
intel-double-precision-no-mpi-omp-avx512-jobs:
  tags:
    - KNL
  script:
    - ./autogen.sh
    - export MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_OMP="-L$MKLROOT/lib/intel64 -lmkl_intel_lp64 -lmkl_sequential -lmkl_core -lpthread -Wl,-rpath,$MKLROOT/lib/intel64"
    - export MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_OMP="-I$MKLROOT/include/intel64/lp64"
    - ./configure  FC=ifort CC=icc --enable-option-checking=fatal CFLAGS="-O3 -mtune=knl -xMIC-AVX512" FCFLAGS="-O3 -axMIC-AVX512" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_OMP" --enable-avx512 --with-mpi=0 --enable-openmp || { cat config.log; exit 1; }
      # - /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 2000 )
    - make -j 8
    - export OMP_NUM_THREADS=2
    - export LD_LIBRARY_PATH=$MKLROOT/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# intel double precision no mpi omp AVX512 large
intel-double-precision-no-mpi-omp-large-avx512-jobs:
  tags:
    - KNL
  script:
    - ./autogen.sh
    - export MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_OMP="-L$MKLROOT/lib/intel64 -lmkl_intel_lp64 -lmkl_sequential -lmkl_core -lpthread -Wl,-rpath,$MKLROOT/lib/intel64"
    - export MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_OMP="-I$MKLROOT/include/intel64/lp64"
    - ./configure  FC=ifort CC=icc --enable-option-checking=fatal CFLAGS="-O3 -mtune=knl -xMIC-AVX512" FCFLAGS="-O3 -axMIC-AVX512" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_OMP" --enable-avx512 --with-mpi=0 --enable-openmp || { cat config.log; exit 1; }
      # - /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 2000 )
    - make -j 8
    - export LD_LIBRARY_PATH=$MKLROOT/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=2
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# intel single precision no mpi omp AVX512
intel-single-precision-no-mpi-omp-avx512-jobs:
  tags:
    - KNL
  script:
    - ./autogen.sh
    - export MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_OMP="-L$MKLROOT/lib/intel64 -lmkl_intel_lp64 -lmkl_sequential -lmkl_core -lpthread -Wl,-rpath,$MKLROOT/lib/intel64"
    - export MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_OMP="-I$MKLROOT/include/intel64/lp64"
    - ./configure  FC=ifort CC=icc --enable-option-checking=fatal CFLAGS="-O3 -mtune=knl -xMIC-AVX512" FCFLAGS="-O3 -axMIC-AVX512" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_OMP" --enable-avx512 --with-mpi=0 --enable-single-precision --enable-openmp || { cat config.log; exit 1; }
      # - /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 3600 )
    - make -j 8
    - export LD_LIBRARY_PATH=$MKLROOT/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=2
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran double precision no mpi omp AVX512
gfortran-double-precision-no-mpi-omp-avx512-jobs:
  tags:
    - KNL
  script:
    - ./autogen.sh
    - export MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP="-L$MKLROOT/lib/intel64 -lmkl_gf_lp64 -lmkl_sequential -lmkl_core -lpthread -Wl,-rpath,$MKLROOT/lib/intel64"
    - export MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP="-I$MKLROOT/include/intel64/lp64"
    - ./configure  FC=gfortran CC=gcc --enable-option-checking=fatal CFLAGS="-O3 -march=native -fsanitize=address" FCFLAGS="-O3 -march=native -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --enable-avx512 --with-mpi=0 --disable-mpi-module --enable-openmp || { cat config.log; exit 1; }
      # - /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 2000 )
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=2
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran single precision no mpi omp AVX512
gfortran-single-precision-no-mpi-omp-avx512-jobs:
  tags:
    - KNL
  script:
    - ./autogen.sh
    - export MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP="-L$MKLROOT/lib/intel64 -lmkl_gf_lp64 -lmkl_sequential -lmkl_core -lpthread -Wl,-rpath,$MKLROOT/lib/intel64"
    - export MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP="-I$MKLROOT/include/intel64/lp64"
    - ./configure  FC=gfortran CC=gcc --enable-option-checking=fatal CFLAGS="-O3 -march=native -fsanitize=address" FCFLAGS="-O3 -march=native -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --enable-avx512 --with-mpi=0 --disable-mpi-module --enable-single-precision --enable-openmp || { cat config.log; exit 1; }
      # - /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 2000 )
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=2
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran double precision no mpi omp AVX512, no assumed size
gfortran-double-precision-no-mpi-omp-no-assumed-size-avx512-jobs:
  tags:
    - KNL
  script:
    - ./autogen.sh
    - export MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP="-L$MKLROOT/lib/intel64 -lmkl_gf_lp64 -lmkl_sequential -lmkl_core -lpthread -Wl,-rpath,$MKLROOT/lib/intel64"
    - export MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP="-I$MKLROOT/include/intel64/lp64"
    - ./configure  FC=gfortran CC=gcc --enable-option-checking=fatal CFLAGS="-O3 -march=native -fsanitize=address" FCFLAGS="-O3 -march=native -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --enable-avx512 --with-mpi=0 --disable-mpi-module --disable-assumed-size --enable-openmp || { cat config.log; exit 1; }
      # - /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 2000)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=2
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran single precision no-mpi omp AVX512, no assumed size
gfortran-single-precision-no-mpi-omp-no-assumed-size-avx512-jobs:
  tags:
    - KNL
  script:
    - ./autogen.sh
    - export MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP="-L$MKLROOT/lib/intel64 -lmkl_gf_lp64 -lmkl_sequential -lmkl_core -lpthread -Wl,-rpath,$MKLROOT/lib/intel64"
    - export MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP="-I$MKLROOT/include/intel64/lp64"
    - ./configure  FC=gfortran CC=gcc --enable-option-checking=fatal CFLAGS="-O3 -march=native -fsanitize=address" FCFLAGS="-O3 -march=native -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --enable-avx512 --with-mpi=0 --disable-mpi-module --disable-assumed-size --enable-single-precision --enable-openmp || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 2000)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=2
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

      # no coverage on system with tag AVX2
      #
      ## gfortran double precision mpi noomp AVX2 COVERAGE
      #gfortran-double-precision-mpi-noomp-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran single precision mpi noomp AVX2 COVERAGE
      #gfortran-double-precision-mpi-noomp-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --enable-single-precision || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran double precision mpi noomp AVX2, no assumed size COVERAGE
      #gfortran-double-precision-mpi-noomp-no-assumed-size-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --disable-assumed-size || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran single precision mpi noomp AVX2 no assumed size COVERAGE
      #gfortran-double-precision-mpi-noomp-no-assumed-size-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --enable-single-precision --disable-assumed-size || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data


########################################################################################
#
# jobs for intel/gfortran double/single precision mpi and no openmp no cuda SKYLAKE
# - all runners on "cpu"
# - including coverage runs
#
########################################################################################
# intel double precision mpi noomp skylake
intel-double-precision-mpi-noomp-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=mpiifort CC=mpiicc --enable-option-checking=fatal CFLAGS="-O3 -xCORE-AVX512" FCFLAGS="-O3 -xCORE-AVX512" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_NO_OMP" --enable-avx512 || { cat config.log; exit 1; }
      # - /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKLROOT/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# intel double precision mpi noomp skylake large
intel-double-precision-mpi-noomp-large-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=mpiifort CC=mpiicc --enable-option-checking=fatal CFLAGS="-O3 -xCORE-AVX512" FCFLAGS="-O3 -xCORE-AVX512" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_NO_OMP" --enable-avx512 || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKLROOT/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# intel single precision mpi noomp SKYLAKE
intel-single-precision-mpi-noomp-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=mpiifort CC=mpiicc --enable-option-checking=fatal CFLAGS="-O3 -xCORE-AVX512" FCFLAGS="-O3 -xCORE-AVX512" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_NO_OMP" --enable-avx512 --enable-single-precision || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKLROOT/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran double precision mpi noomp SKTLAKE
gfortran-double-precision-mpi-noomp-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=mpif90 CC=mpicc --enable-option-checking=fatal CFLAGS="-O3 -march=skylake-avx512" FCFLAGS="-O3 -march=skylake-avx512" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --enable-avx512 || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran single precision mpi noomp SKYLAKE
gfortran-single-precision-mpi-noomp-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=mpif90 CC=mpicc --enable-option-checking=fatal CFLAGS="-O3 -march=skylake-avx512" FCFLAGS="-O3 -march=skylake-avx512" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --enable-avx512 --enable-single-precision || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 1800)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - make check TASKS=3 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - make check TASKS=4 TEST_FLAGS='1500 500 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - make check TASKS=5 TEST_FLAGS='1500 500 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - make check TASKS=6 TEST_FLAGS='1500 500 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - make check TASKS=7 TEST_FLAGS='1500 500 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - make check TASKS=8 TEST_FLAGS='1500 500 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - make check TASKS=9 TEST_FLAGS='1500 500 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - make check TASKS=10 TEST_FLAGS='1500 500 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - make check TASKS=11 TEST_FLAGS='1500 500 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - make check TASKS=12 TEST_FLAGS='1500 500 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - make check TASKS=14 TEST_FLAGS='1500 500 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran double precision mpi noomp skylake, no assumed size
gfortran-double-precision-mpi-noomp-no-assumed-size-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=mpif90 CC=mpicc --enable-option-checking=fatal CFLAGS="-O3 -march=skylake-avx512" FCFLAGS="-O3 -march=skylake-avx512" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --enable-avx512 --disable-assumed-size || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran single precision mpi noomp skylake, no assumed size
gfortran-single-precision-mpi-noomp-no-assumed-size-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=mpif90 CC=mpicc --enable-option-checking=fatal CFLAGS="-O3 -march=skylake-avx512" FCFLAGS="-O3 -march=skylake-avx512" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --enable-avx512 --disable-assumed-size --enable-single-precision || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID


# gfortran double precision mpi noomp skylake, no assumed size coveravge
gfortran-double-precision-mpi-noomp-no-assumed-size-skylake-coverage-jobs:
  tags:
    - skylake-coverage
  script:
    - ./autogen.sh
    - ./configure  FC=mpif90 CC=mpicc --enable-option-checking=fatal CFLAGS="-O3 --coverage -march=skylake-avx512" FCFLAGS="-O3 --coverage -march=skylake-avx512" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --enable-avx512 --disable-assumed-size || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
    - gpschedule -d $GPJOBID
  artifacts:
    paths:
      - coverage_data

# gfortran single precision mpi noomp skylake, no assumed size coveravge
gfortran-single-precision-mpi-noomp-no-assumed-size-skylake-coverage-jobs:
  tags:
    - skylake-coverage
  script:
    - ./autogen.sh
    - ./configure  FC=mpif90 CC=mpicc --enable-option-checking=fatal CFLAGS="-O3 --coverage -march=skylake-avx512" FCFLAGS="-O3 --coverage -march=skylake-avx512" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --enable-avx512 --disable-assumed-size --enable-single-precision || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
    - gpschedule -d $GPJOBID
  artifacts:
    paths:
      - coverage_data




      #gfortran-double-precision-mpi-noomp-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran single precision mpi noomp AVX2 COVERAGE
      #gfortran-double-precision-mpi-noomp-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --enable-single-precision || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran double precision mpi noomp AVX2, no assumed size COVERAGE
      #gfortran-double-precision-mpi-noomp-no-assumed-size-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --disable-assumed-size || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran single precision mpi noomp AVX2 no assumed size COVERAGE
      #gfortran-double-precision-mpi-noomp-no-assumed-size-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --enable-single-precision --disable-assumed-size || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data


########################################################################################
#
# jobs for intel/gfortran double/single precision mpi and openmp no cuda SKYLAKE
# - all runners on "cpu"
# - including coverage runs
#
########################################################################################
# intel double precision mpi omp skylake
intel-double-precision-mpi-omp-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=mpiifort CC=mpiicc --enable-option-checking=fatal CFLAGS="-O3 -xCORE-AVX512" FCFLAGS="-O3 -xCORE-AVX512" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_OMP" --enable-avx512 --enable-openmp || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKLROOT/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=2
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# intel double precision mpi omp skylake large
intel-double-precision-mpi-omp-large-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=mpiifort CC=mpiicc --enable-option-checking=fatal CFLAGS="-O3 -xCORE-AVX512" FCFLAGS="-O3 -xCORE-AVX512" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_OMP" --enable-avx512 --enable-openmp || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKLROOT/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=2
    - make check TASKS=2 TEST_FLAGS='1500 500 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

      #### intel single precision mpi noomp SKYLAKE
      ###intel-single-precision-mpi-omp-skylake-jobs:
      ###  tags:
      ###    - skylake
      ###  script:
      ###    - ./autogen.sh
      ###    - ./configure  FC=mpiifort CC=mpiicc --enable-option-checking=fatal CFLAGS="-O3 -xCORE-AVX512" FCFLAGS="-O3 -xCORE-AVX512" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_OMP" --enable-avx512 --enable-single-precision --enable-openmp || { cat config.log; exit 1; }
      ###      #- /home/elpa/wait_until_midnight.sh
      ###    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
      ###    - make -j 8
      ###    - export LD_LIBRARY_PATH=$MKLROOT/lib/intel64:$LD_LIBRARY_PATH
      ###    - export OMP_NUM_THREADS=2
      ###    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      ###    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      ###    - gpschedule -d $GPJOBID

# gfortran double precision mpi omp SKTLAKE
gfortran-double-precision-mpi-omp-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=mpif90 CC=mpicc --enable-option-checking=fatal CFLAGS="-O3 -march=skylake-avx512" FCFLAGS="-O3 -march=skylake-avx512" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI__OMP" --enable-avx512 --enable-openmp || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=2
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran double precision mpi omp skylake
gfortran-double-precision-mpi-omp-skylake-coverage-jobs:
  tags:
    - skylake-coverage
  script:
    - ./autogen.sh
    - ./configure  FC=mpif90 CC=mpicc --enable-option-checking=fatal CFLAGS="-O3 --coverage -march=skylake-avx512" FCFLAGS="-O3 --coverage -march=skylake-avx512" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --enable-avx512 --enable-openmp || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=1
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - ./ci_coverage_collect
    - gpschedule -d $GPJOBID
  artifacts:
    paths:
      - coverage_data

        ## gfortran single precision mpi omp SKYLAKE
        #gfortran-single-precision-mpi-omp-skylake-jobs:
        #  tags:
        #    - skylake
        #  script:
        #    - ./autogen.sh
        #    - ./configure  FC=mpif90 CC=mpicc --enable-option-checking=fatal CFLAGS="-O3 -march=skylake-avx512" FCFLAGS="-O3 -march=skylake-avx512" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" --enable-avx512 --enable-single-precision --enable-openmp || { cat config.log; exit 1; }
        #      #- /home/elpa/wait_until_midnight.sh
        #    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
        #    - make -j 8
        #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
        #    - export OMP_NUM_THREADS=2
        #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
        #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
        #    - gpschedule -d $GPJOBID

      #### gfortran single precision mpi omp skylake
      ###gfortran-single-precision-mpi-omp-skylake-coverage-jobs:
      ###  tags:
      ###    - skylake-coverage
      ###  script:
      ###    - ./autogen.sh
      ###    - ./configure  FC=mpif90 CC=mpicc --enable-option-checking=fatal CFLAGS="-O3 --coverage -march=skylake-avx512" FCFLAGS="-O3 --coverage -march=skylake-avx512" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" --enable-avx512 --enable-openmp --enable-single-precision || { cat config.log; exit 1; }
      ###      #- /home/elpa/wait_until_midnight.sh
      ###    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
      ###    - make -j 8
      ###    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      ###    - export OMP_NUM_THREADS=1
      ###    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      ###    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      ###    - ./ci_coverage_collect
      ###    - gpschedule -d $GPJOBID
      ###  artifacts:
      ###    paths:
      ###      - coverage_data

# gfortran double precision mpi omp skylake, no assumed size
gfortran-double-precision-mpi-omp-no-assumed-size-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=mpif90 CC=mpicc --enable-option-checking=fatal CFLAGS="-O3 -march=skylake-avx512" FCFLAGS="-O3 -march=skylake-avx512" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" --enable-avx512 --disable-assumed-size --enable-openmp || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=2
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

      ## gfortran single precision mpi omp skylake, no assumed size
      #gfortran-single-precision-mpi-omp-no-assumed-size-skylake-jobs:
      #  tags:
      #    - skylake
      #  script:
      #    - ./autogen.sh
      #    - ./configure  FC=mpif90 CC=mpicc --enable-option-checking=fatal CFLAGS="-O3 -march=skylake-avx512" FCFLAGS="-O3 -march=skylake-avx512" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_OMP" --enable-avx512 --disable-assumed-size --enable-single-precision --enable-openmp || { cat config.log; exit 1; }
      #      #- /home/elpa/wait_until_midnight.sh
      #    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - export OMP_NUM_THREADS=2
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - gpschedule -d $GPJOBID

      # no coverage on system with tag AVX2
      #
      ## gfortran double precision mpi noomp AVX2 COVERAGE
      #gfortran-double-precision-mpi-noomp-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran single precision mpi noomp AVX2 COVERAGE
      #gfortran-double-precision-mpi-noomp-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --enable-single-precision || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran double precision mpi noomp AVX2, no assumed size COVERAGE
      #gfortran-double-precision-mpi-noomp-no-assumed-size-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --disable-assumed-size || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran single precision mpi noomp AVX2 no assumed size COVERAGE
      #gfortran-double-precision-mpi-noomp-no-assumed-size-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --enable-single-precision --disable-assumed-size || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data


########################################################################################
#
# jobs for intel/gfortran double/single precision no mpi and no openmp no cuda SKYLAKE
# - all runners on "cpu"
# - including coverage runs
#
########################################################################################
# intel double precision nompi noomp skylake
intel-double-precision-no-mpi-noomp-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=ifort CC=icc --enable-option-checking=fatal CFLAGS="-O3 -xCORE-AVX512" FCFLAGS="-O3 -xCORE-AVX512" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --enable-avx512 --with-mpi=0 || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKLROOT/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# intel double precision no-mpi noomp skylake large
intel-double-precision-no-mpi-noomp-large-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=ifort CC=icc --enable-option-checking=fatal CFLAGS="-O3 -xCORE-AVX512" FCFLAGS="-O3 -xCORE-AVX512" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --enable-avx512 --with-mpi=0 || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKLROOT/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

      #### intel single precision no mpi noomp SKYLAKE
      ###intel-single-precision-no-mpi-noomp-skylake-jobs:
      ###  tags:
      ###    - skylake
      ###  script:
      ###    - ./autogen.sh
      ###    - ./configure  FC=ifort CC=icc --enable-option-checking=fatal CFLAGS="-O3 -xCORE-AVX512" FCFLAGS="-O3 -xCORE-AVX512" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --enable-avx512 --enable-single-precision --with-mpi=0 || { cat config.log; exit 1; }
      ###      #- /home/elpa/wait_until_midnight.sh
      ###    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
      ###    - make -j 8
      ###    - export LD_LIBRARY_PATH=$MKLROOT/lib/intel64:$LD_LIBRARY_PATH
      ###    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      ###    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      ###    - gpschedule -d $GPJOBID

# gfortran double precision no mpi noomp SKYLAKE
gfortran-double-precision-no-mpi-noomp-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=gfortran CC=gcc --enable-option-checking=fatal CFLAGS="-O3 -march=skylake-avx512 -fsanitize=address" FCFLAGS="-O3 -march=skylake-avx512 -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --enable-avx512 --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran single precision no mpi noomp SKYLAKE
gfortran-single-precision-no-mpi-noomp-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=gfortran CC=gcc --enable-option-checking=fatal CFLAGS="-O3 -march=skylake-avx512 -fsanitize=address" FCFLAGS="-O3 -march=skylake-avx512 -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --enable-avx512 --enable-single-precision --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran double precision no mpi noomp skylake, no assumed size
gfortran-double-precision-no-mpi-noomp-no-assumed-size-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=gfortran CC=gcc --enable-option-checking=fatal CFLAGS="-O3 -march=skylake-avx512 -fsanitize=address" FCFLAGS="-O3 -march=skylake-avx512 -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --enable-avx512 --disable-assumed-size --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran single precision no mpi noomp skylake, no assumed size
gfortran-single-precision-no-mpi-noomp-no-assumed-size-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=gfortran CC=gcc --enable-option-checking=fatal CFLAGS="-O3 -march=skylake-avx512 -fsanitize=address" FCFLAGS="-O3 -march=skylake-avx512 -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --enable-avx512 --disable-assumed-size --enable-single-precision --with-mpi=0 --disable-mpi-module || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

      # no coverage on system with tag AVX2
      #
      ## gfortran double precision mpi noomp AVX2 COVERAGE
      #gfortran-double-precision-mpi-noomp-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran single precision mpi noomp AVX2 COVERAGE
      #gfortran-double-precision-mpi-noomp-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --enable-single-precision || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran double precision mpi noomp AVX2, no assumed size COVERAGE
      #gfortran-double-precision-mpi-noomp-no-assumed-size-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --disable-assumed-size || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran single precision mpi noomp AVX2 no assumed size COVERAGE
      #gfortran-double-precision-mpi-noomp-no-assumed-size-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --enable-single-precision --disable-assumed-size || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data


########################################################################################
#
# jobs for intel/gfortran double/single precision no mpi and openmp no cuda SKYLAKE
# - all runners on "cpu"
# - including coverage runs
#
########################################################################################
# intel double precision nompi omp skylake
intel-double-precision-no-mpi-omp-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=ifort CC=icc --enable-option-checking=fatal CFLAGS="-O3 -xCORE-AVX512" FCFLAGS="-O3 -xCORE-AVX512" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_OMP" --enable-avx512 --with-mpi=0 --enable-openmp || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKLROOT/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=2
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# intel double precision no-mpi omp skylake large
intel-double-precision-no-mpi-omp-large-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=ifort CC=icc --enable-option-checking=fatal CFLAGS="-O3 -xCORE-AVX512" FCFLAGS="-O3 -xCORE-AVX512" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_OMP" --enable-avx512 --with-mpi=0 --enable-openmp || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKLROOT/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=2
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

      #### intel single precision no mpi omp SKYLAKE
      ###intel-single-precision-no-mpi-omp-skylake-jobs:
      ###  tags:
      ###    - skylake
      ###  script:
      ###    - ./autogen.sh
      ###    - ./configure  FC=ifort CC=icc --enable-option-checking=fatal CFLAGS="-O3 -xCORE-AVX512" FCFLAGS="-O3 -xCORE-AVX512" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_OMP" --enable-avx512 --enable-single-precision --with-mpi=0 --enable-openmp || { cat config.log; exit 1; }
      ###      #- /home/elpa/wait_until_midnight.sh
      ###    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
      ###    - make -j 8
      ###    - export LD_LIBRARY_PATH=$MKLROOT/lib/intel64:$LD_LIBRARY_PATH
      ###    - export OMP_NUM_THREADS=2
      ###    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      ###    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      ###    - gpschedule -d $GPJOBID

# gfortran double precision no mpi omp SKYLAKE
gfortran-double-precision-no-mpi-omp-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=gfortran CC=gcc --enable-option-checking=fatal CFLAGS="-O3 -march=skylake-avx512 -fsanitize=address" FCFLAGS="-O3 -march=skylake-avx512 -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --enable-avx512 --with-mpi=0 --disable-mpi-module --enable-openmp || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=2
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran single precision no mpi omp SKYLAKE
gfortran-single-precision-no-mpi-omp-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=gfortran CC=gcc --enable-option-checking=fatal CFLAGS="-O3 -march=skylake-avx512 -fsanitize=address" FCFLAGS="-O3 -march=skylake-avx512 -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --enable-avx512 --enable-single-precision --with-mpi=0 --disable-mpi-module --enable-openmp || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=2
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran double precision no mpi omp skylake, no assumed size
gfortran-double-precision-no-mpi-omp-no-assumed-size-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=gfortran CC=gcc --enable-option-checking=fatal CFLAGS="-O3 -march=skylake-avx512 -fsanitize=address" FCFLAGS="-O3 -march=skylake-avx512 -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --enable-avx512 --disable-assumed-size --with-mpi=0 --disable-mpi-module --enable-openmp || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=2
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

# gfortran single precision no mpi omp skylake, no assumed size
gfortran-single-precision-no-mpi-omp-no-assumed-size-skylake-jobs:
  tags:
    - skylake
  script:
    - ./autogen.sh
    - ./configure  FC=gfortran CC=gcc --enable-option-checking=fatal CFLAGS="-O3 -march=skylake-avx512 -fsanitize=address" FCFLAGS="-O3 -march=skylake-avx512 -fsanitize=address" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_NO_MPI_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_NO_MPI_OMP" --enable-avx512 --disable-assumed-size --enable-single-precision --with-mpi=0 --disable-mpi-module --enable-openmp || { cat config.log; exit 1; }
      #- /home/elpa/wait_until_midnight.sh
    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot 600)
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - export OMP_NUM_THREADS=2
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
    - gpschedule -d $GPJOBID

      # no coverage on system with tag AVX2
      #
      ## gfortran double precision mpi noomp AVX2 COVERAGE
      #gfortran-double-precision-mpi-noomp-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran single precision mpi noomp AVX2 COVERAGE
      #gfortran-double-precision-mpi-noomp-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --enable-single-precision || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran double precision mpi noomp AVX2, no assumed size COVERAGE
      #gfortran-double-precision-mpi-noomp-no-assumed-size-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --disable-assumed-size || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data
      #
      ## gfortran single precision mpi noomp AVX2 no assumed size COVERAGE
      #gfortran-double-precision-mpi-noomp-no-assumed-size-coverage-avx2-jobs:
      #  tags:
      #    - avx2
      #  script:
      #    - ./autogen.sh
      #    - ./configure --enable-option-checking=fatal CFLAGS="--coverage -O3 -mavx2 -mfma" FCFLAGS="--coverage -O3 -mavx2 -mfma" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --enable-single-precision --disable-assumed-size || { cat config.log; exit 1; }
      #    - make -j 8
      #    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
      #    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - ./ci_coverage_collect
      #  artifacts:
      #    paths:
      #      - coverage_data


static-build:
  tags:
    - cpu
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal CFLAGS="-O3 -mavx" FCFLAGS="-O3 -axAVX" SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_NO_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_NO_MPI_NO_OMP" --with-mpi=no FC=ifort --enable-shared=no --enable-static=yes --disable-avx2 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - make check TASKS=2 TEST_FLAGS='150 50 16' || { cat test-suite.log; exit 1; }
    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;

# test distcheck
distcheck:
  tags:
    - buildtest
  script:
    - ./autogen.sh
    - ./configure --enable-option-checking=fatal --with-mpi=no --disable-sse-assembly --disable-sse --disable-avx --disable-avx2 || { cat config.log; exit 1; }
    # stupid 'make distcheck' leaves behind write-protected files that the stupid gitlab runner cannot remove
    - make distcheck DISTCHECK_CONFIGURE_FLAGS="--with-mpi=no --disable-sse-assembly --disable-sse --disable-avx --disable-avx2" TASKS=2 TEST_FLAGS='150 50 16' || { chmod u+rwX -R . ; exit 1 ; }

# test test_project_legacy_api
test_project_legacy_api:
  tags:
    - buildtest
  script:
    - mkdir build
    - pushd build
    - ../autogen.sh
    - ../configure --enable-option-checking=fatal FCFLAGS="-march=native" CFLAGS="-march=native" --disable-avx2 SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --prefix=$PWD/installdest --disable-avx2 || { cat config.log; exit 1; }
    - make -j 8
    - make install
    - popd
    - mkdir test_project_legacy_api/build
    - pushd test_project_legacy_api/build
    - ../autogen.sh
    - ../configure --enable-option-checking=fatal PKG_CONFIG_PATH=../../build/installdest/lib/pkgconfig FC=mpif90 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - ./test_real
    - make distclean
    - popd
    - pushd build
    - make distclean
    - rm -rf installdest
    - popd


# test test_project_2stage_legacy_api
test_project_2stage_legacy_api:
  tags:
    - buildtest
  script:
    - mkdir build
    - pushd build
    - ../autogen.sh
    - ../configure --enable-option-checking=fatal FCFLAGS="-march=native" CFLAGS="-march=native" SCALAPACK_LDFLAGS="$MKL_GFORTRAN_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_GFORTRAN_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpif90 --prefix=$PWD/installdest --disable-avx2 || { cat config.log; exit 1; }
    - make -j 8
    - make install
    - popd
    - mkdir test_project_2stage_legacy_api/build
    - pushd test_project_2stage_legacy_api/build
    - ../autogen.sh
    - ../configure --enable-option-checking=fatal PKG_CONFIG_PATH=../../build/installdest/lib/pkgconfig FC=mpif90 || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - ./test_real2
    - make distclean
    - popd
    - pushd build
    - make distclean
    - rm -rf installdest
    - popd


test_project_intel_legacy_api:
  tags:
    - buildtest
  script:
    - mkdir build
    - pushd build
    - ../autogen.sh
    - ../configure --enable-option-checking=fatal SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpiifort --prefix=$PWD/installdest --disable-sse-assembly --disable-sse --disable-avx --disable-avx2 || { cat config.log; exit 1; }
    - make -j 8
    - make install
    - popd
    - mkdir test_project_legacy_api/build
    - pushd test_project_legacy_api/build
    - ../autogen.sh
    - ../configure --enable-option-checking=fatal PKG_CONFIG_PATH=../../build/installdest/lib/pkgconfig FC=mpiifort || { cat config.log; exit 1; }
    - make -j 8
    - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
    - ./test_real
    - make distclean
    - popd
    - pushd build
    - make distclean
    - rm -rf installdest


test_project_2stage_intel_legacy_api:
 tags:
   - buildtest
 script:
   - mkdir build
   - pushd build
   - ../autogen.sh
   - ../configure --enable-option-checking=fatal SCALAPACK_LDFLAGS="$MKL_INTEL_SCALAPACK_LDFLAGS_MPI_NO_OMP" SCALAPACK_FCFLAGS="$MKL_INTEL_SCALAPACK_FCFLAGS_MPI_NO_OMP" FC=mpiifort --prefix=$PWD/installdest --disable-sse-assembly --disable-sse --disable-avx --disable-avx2 || { cat config.log; exit 1; }
   - make -j 8
   - make install
   - popd
   - mkdir test_project_2stage_legacy_api/build
   - pushd test_project_2stage_legacy_api/build
   - ../autogen.sh
   - ../configure --enable-option-checking=fatal PKG_CONFIG_PATH=../../build/installdest/lib/pkgconfig FC=mpiifort || { cat config.log; exit 1; }
   - make -j 8
   - export LD_LIBRARY_PATH=$MKL_HOME/lib/intel64:$LD_LIBRARY_PATH
   - ./test_real2
   - make distclean
   - popd
   - pushd build
   - make distclean
   - rm -rf installdest

     #minsky:
     #  tags:
     #    - miy
     #  script:
     #    - module purge
     #    - module load gcc/5.4 pgi/17.5 ompi/pgi/17.5/1.10.2 essl/5.5 cuda/8.0
     #    - module list
     #    - export OMPI_CC=gcc
     #    - export OMPI_FC=pgfortran
     #    - export LD_LIBRARY_PATH=/opt/ibm/spectrum_mpi/lib:/opt/ibm/spectrum_mpi/profilesupport/lib:$LD_LIBRARY_PATH
     #    - export PATH=/opt/ibm/spectrum_mpi/bin:$PATH
     #    - ./autogen.sh
     #    - ./configure CC=mpicc FC=mpifort LIBS="-lessl -lreflapack -lessl -lcublas -lgfortran" LDFLAGS="-g -L/home/elpa/libs/scalapack/lib -L/usr/local/cuda-8.0/lib64 " FCFLAGS="-g -O2 " CFLAGS="-g -O2 -I/usr/local/cuda-8.0/include" --enable-single-precision --disable-mpi-module --enable-gpu --with-GPU-compute-capability=sm_60 --disable-sse --disable-sse-assembly --disable-avx --disable-avx2 --with-cuda-path=/usr/local/cuda-8.0/ || { cat config.log; exit 1; }
     #    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot)
     #    - make -j 8
     #    - make check TASKS=2 TEST_FLAGS='150 50 32'  || { cat test-suite.log; exit 1; }
     #    - cat test-suite.log
     #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
     #    - gpschedule -d $GPJOBID

      #minsky-pure-gnu:
      #  tags:
      #    - miy
      #  script:
      #    - module purge
      #    - module load gcc/5.4 ompi/pgi/17.5/1.10.2 essl/5.5 cuda/8.0
      #    - module list
      #    - export OMPI_CC=gcc
      #    - export OMPI_FC=gfortran
      #    - ./autogen.sh
      #    - export LD_LIBRARY_PATH=/opt/ibm/spectrum_mpi/lib:/opt/ibm/spectrum_mpi/profilesupport/lib:$LD_LIBRARY_PATH
      #    - export PATH=/opt/ibm/spectrum_mpi/bin:$PATH
      #    - ./configure CC=mpicc FC=mpifort LIBS="-lessl -lreflapack -lessl -lcublas -lgfortran" LDFLAGS="-g -L/home/elpa/libs/scalapack/lib -L/usr/local/cuda-8.0/lib64 " FCFLAGS="-g -O2 " CFLAGS="-g -O2 -I/usr/local/cuda-8.0/include" --enable-single-precision --disable-mpi-module --enable-gpu --with-GPU-compute-capability=sm_60 --disable-sse --disable-sse-assembly --disable-avx --disable-avx2 --with-cuda-path=/usr/local/cuda-8.0/ || { cat config.log; exit 1; }
      #    - GPJOBID=$(/home/elpa/bin/reserve_timeslot/reserve_timeslot)
      #    - make -j 8
      #    - make check TASKS=2 TEST_FLAGS='150 50 32'  || { cat test-suite.log; exit 1; }
      #    - cat test-suite.log
      #    - grep -i "Expected %stop" test-suite.log && exit 1 || true ;
      #    - gpschedule -d $GPJOBID


# print coverage results
total_coverage:
  stage: coverage
  tags:
    - coverage
  script:
    - echo "Generating coverage report"
    - ./ci_coverage_summary
  artifacts:
    paths:
      - public

pages:
  stage: deploy
  tags:
    - coverage
  script:
    - echo "Publishing pages"
  artifacts:
    paths:
      - public
  only:
    - master
